import os
os.mkdir("geoms")
memory 64 GB
set_num_threads(16)

molecule na1t_base {
0 1
C       -3.9990700000      0.8177600000      1.2519500000                 
C       -4.3328100000     -0.3096100000      0.5003100000                 
C       -2.2784200000     -0.1054400000     -0.7822800000                 
C       -1.9336500000      1.0233400000     -0.0166500000                 
O       -0.8092600000      3.0640400000     -0.3869000000                 
H       -2.5354000000      2.3752700000      1.5245600000                 
C       -3.4865900000     -0.7617400000     -0.5036900000                 
H       -5.2620800000     -0.8383400000      0.6938500000                 
H       -3.7536200000     -1.6375800000     -1.0916400000                 
C       -2.8091800000      1.4786100000      0.9757400000                 
C       -0.7025200000      1.8576200000     -0.2574500000                 
C        4.6231500000     -0.6078400000      0.2509300000                 
H        5.5444900000     -0.0334700000      0.2571000000                 
C        0.8839300000     -0.0214000000      0.1290100000                 
C        0.6431000000      1.2351800000     -0.2777900000                 
C        2.2556500000     -2.0686100000      0.2910900000                 
C        4.6665500000     -2.0015000000      0.3246800000                 
H        1.4375800000      1.9096000000     -0.5892200000                 
C        2.1994700000     -0.6711100000      0.2012500000                 
C        3.4012600000      0.0525100000      0.1905600000                 
H        3.3796900000      1.1379100000      0.1631000000                 
C        3.4790600000     -2.7309000000      0.3458900000                 
N        5.6231900000     -2.5124800000      0.3824200000                 
H        1.3263300000     -2.6332200000      0.3145000000                 
H        3.5053400000     -3.8146400000      0.4173200000                 
N       -1.4517900000     -0.6202800000     -1.7942400000                 
H       -0.7354300000      0.0132500000     -2.1293600000                 
H       -1.9706400000     -1.0186400000     -2.5677300000                 
H        0.0389600000     -0.6431500000      0.4246700000                 
N       -4.7800581732      1.2583956641      2.0740234254                 
H        6.4599350767     -1.9939578886      0.3671639629                 
H        5.6536022074     -3.4941857844      0.4500151214                 
H       -5.6214928661      0.7833212055      2.2625232036                 
H       -4.5361017430      2.0547068833      2.5990129036                     
}

vecs = [
[0.0019446903811498667, 0.0, 0.0],
[0.001776563064220719, 0.000790976837450695, 0.0],
[0.0013012518539190494, 0.001445186593907185, 0.0],
[0.0006009423765728028, 0.0018495104591690864, 0.0],
[-0.00020327549707298303, 0.0019340371637656152, 0.0],
[-0.000972345190574933, 0.0016841512725710272, 0.0],
[-0.001573287567147736, 0.0011430603263149204, 0.0],
[-0.0019021942304918524, 0.0004043238652619016, 0.0],
[-0.0019021942304918522, -0.00040432386526190157, 0.0],
[-0.001573287567147736, -0.0011430603263149204, 0.0],
[-0.0009723451905749344, -0.0016841512725710263, 0.0],
[-0.00020327549707298262, -0.0019340371637656156, 0.0],
[0.0006009423765728025, -0.0018495104591690866, 0.0],
[0.0013012518539190485, -0.0014451865939071856, 0.0],
[0.0017765630642207191, -0.000790976837450695, 0.0],
[0.0011972709491103435, 0.0, 0.00153243693278165],
[0.0010937614371272, 0.0007909768374506951, 0.001399950799066436],
[0.0008011306361540498, 0.001445186593907185, 0.0010254004540388943],
[0.0003699770701465192, 0.0018495104591690864, 0.00047354905503734895],
[-0.00012514889242550942, 0.0019340371637656152, -0.00016018327763826236],
[-0.0005986354745551717, 0.0016841512725710272, -0.0007662184663908247],
[-0.0009686125447016908, 0.0011430603263149202, -0.0012397675214281736],
[-0.001171107706300569, 0.0004043238652619017, -0.0014989495090762433],
[-0.001171107706300569, -0.0004043238652619017, -0.0014989495090762433],
[-0.0009686125447016909, -0.0011430603263149202, -0.0012397675214281738],
[-0.0005986354745551723, -0.0016841512725710266, -0.0007662184663908257],
[-0.000125148892425509, -0.0019340371637656156, -0.00016018327763826207],
[0.0003699770701465188, -0.0018495104591690866, 0.0004735490550373485],
[0.0008011306361540493, -0.0014451865939071854, 0.0010254004540388936],
[0.0010937614371272, -0.0007909768374506951, 0.001399950799066436],
[-0.00047046318336221605, 5.761512316212122e-20, 0.0018869247657597545],
[-0.0004297895041486308, 0.000790976837450695, 0.0017237915486731524],
[-0.0003148013151526786, 0.001445186593907185, 0.0012625991126663707],
[-0.00014538111888666176, 0.0018495104591690864, 0.000583091819726731],
[4.9176793580860894e-05, 0.0019340371637656152, -0.00019723734606654427],
[0.00023523159168110792, 0.0016841512725710272, -0.000943462382879877],
[0.0003806127105677699, 0.0011430603263149206, -0.001526554202606608],
[0.0004601824340393402, 0.00040432386526190146, -0.001845690932393102],
[0.00046018243403934034, -0.000404323865261902, -0.001845690932393102],
[0.00038061271056777, -0.00114306032631492, -0.0015265542026066082],
[0.00023523159168110824, -0.0016841512725710268, -0.000943462382879878],
[4.91767935808609e-05, -0.0019340371637656156, -0.0001972373460665439],
[-0.0001453811188866618, -0.001849510459169087, 0.0005830918197267307],
[-0.0003148013151526784, -0.0014451865939071858, 0.00126259911266637],
[-0.0004297895041486308, -0.000790976837450695, 0.0017237915486731524],
[-0.0017765630642207187, 2.1756622700813167e-19, 0.0007909768374506956],
[-0.0016229711175344578, 0.0007909768374506955, 0.0007225932969535929],
[-0.0011887527203967606, 0.0014451865939071851, 0.000529266810859196],
[-0.0005489881784230332, 0.0018495104591690866, 0.0002444252849292154],
[0.00018570140700106537, 0.0019340371637656152, -8.267959329902982e-05],
[0.000888281532110359, 0.0016841512725710274, -0.0003954884187253477],
[0.0014372697105333925, 0.0011430603263149204, -0.0006399137036545631],
[0.001737740898819794, 0.0004043238652619016, -0.0007736920957884114],
[0.0017377408988197938, -0.00040432386526190195, -0.0007736920957884113],
[0.0014372697105333927, -0.00114306032631492, -0.0006399137036545632],
[0.00088828153211036, -0.0016841512725710266, -0.00039548841872534817],
[0.00018570140700106496, -0.0019340371637656154, -8.267959329902966e-05],
[-0.0005489881784230328, -0.0018495104591690866, 0.0002444252849292152],
[-0.0011887527203967602, -0.0014451865939071856, 0.0005292668108591957],
[-0.0016229711175344578, -0.0007909768374506955, 0.0007225932969535929],
[-0.001717059690892184, 2.1027916543960568e-19, -0.0009129768323731176],
[-0.001568612081115763, 0.000790976837450695, -0.000834045838147392],
[-0.001148937192121041, 0.0014451865939071847, -0.0006109007414374138],
[-0.0005306006248418791, 0.0018495104591690864, -0.000282125356673901],
[0.00017948161082779215, 0.0019340371637656154, 9.543206528693214e-05],
[0.0008585298454460916, 0.0016841512725710274, 0.0004564884161865587],
[0.0013891304702879706, 0.0011430603263149204, 0.0007386137728604598],
[0.0016795378169629197, 0.0004043238652619015, 0.000893026098111315],
[0.0016795378169629192, -0.00040432386526190184, 0.0008930260981113148],
[0.0013891304702879706, -0.00114306032631492, 0.0007386137728604599],
[0.0008585298454460927, -0.0016841512725710266, 0.00045648841618655924],
[0.00017948161082779172, -0.0019340371637656156, 9.543206528693195e-05],
[-0.0005306006248418786, -0.0018495104591690866, -0.00028212535667390085],
[-0.00114893719212104, -0.0014451865939071854, -0.0006109007414374135],
[-0.001568612081115763, -0.000790976837450695, -0.000834045838147392],
[-0.00033769194081308265, 4.135533544145991e-20, -0.0019151461645646546],
[-0.0003084969386123055, 0.0007909768374506949, -0.001749573079359689],
[-0.0002259600131187576, 0.0014451865939071854, -0.001281482914360989],
[-0.00010435254857470143, 0.0018495104591690866, -0.0005918127115624781],
[3.529841963106313e-05, 0.001934037163765615, 0.00020018728551488406],
[0.00016884597040654105, 0.0016841512725710274, 0.000957573082282327],
[0.0002731985189812426, 0.0011430603263149204, 0.0015493857938448051],
[0.0003303125616934591, 0.0004043238652619017, 0.001873295625923467],
[0.0003303125616934588, -0.00040432386526190184, 0.0018732956259234668],
[0.0002731985189812427, -0.0011430603263149197, 0.0015493857938448051],
[0.00016884597040654132, -0.0016841512725710266, 0.0009575730822823283],
[3.5298419631062706e-05, -0.0019340371637656156, 0.0002001872855148837],
[-0.00010435254857470143, -0.0018495104591690866, -0.0005918127115624777],
[-0.00022596001311875737, -0.0014451865939071856, -0.0012814829143609882],
[-0.0003084969386123055, -0.0007909768374506949, -0.001749573079359689],
[0.0013012518539190485, 0.0, -0.0014451865939071856],
[0.0011887527203967598, 0.0007909768374506951, -0.0013202436483098917],
[0.0008707074420384415, 0.001445186593907185, -0.000967018581882808],
[0.00040210893682289273, 0.0018495104591690864, -0.0004465872175601663],
[-0.00013601785661434317, 0.0019340371637656152, 0.00015106313379613257],
[-0.0006506259269595242, 0.0016841512725710272, 0.0007225932969535926],
[-0.0010527348637824167, 0.0011430603263149204, 0.001169180514513759],
[-0.001272816378861334, 0.0004043238652619014, 0.0014136057994429743],
[-0.0012728163788613338, -0.00040432386526190195, 0.0014136057994429743],
[-0.0010527348637824172, -0.00114306032631492, 0.0011691805145137592],
[-0.0006506259269595248, -0.001684151272571027, 0.0007225932969535934],
[-0.0001360178566143432, -0.0019340371637656154, 0.00015106313379613232],
[0.0004021089368228923, -0.0018495104591690866, -0.000446587217560166],
[0.0008707074420384408, -0.0014451865939071854, -0.0009670185818828076],
[0.0011887527203967598, -0.0007909768374506951, -0.0013202436483098917],
]
ecp = []

set {
    opt_type ts
    geom_maxiter 500
    scf_type df
    dft_spherical_points 590
    dft_radial_points 99
    cubeprop_tasks ['ESP', 'DENSITY']
    dynamic_level 2
}

set optking {
   ensure_bt_convergence true
}

set scf {
  maxiter 500
}

set basis 6-31+G*
optimize('M06-2X', molecule=na1t_base)

base, wfn = energy('M06-2X', return_wfn=True, molecule=na1t_base)

with open("efield_perturbation.csv", "w") as f:
  f.write("x, y, z, e_kjmol, dipole(x), dipole(y), dipole(z)\n")
  f.write("0.00000000e-00, 0.00000000e-00, 0.00000000e-00, {}, {}, {}, {}\n".format(0.000000000000000,
          wfn.variable("CURRENT DIPOLE")[0] / 0.3934303,
          wfn.variable("CURRENT DIPOLE")[1] / 0.3934303,
          wfn.variable("CURRENT DIPOLE")[2] / 0.3934303))
with open("geoms/geom_0.xyz", "w") as f:
    f.write(na1t_base.save_string_xyz_file())
del wfn

set {
  perturb_h true
  perturb_with dipole
}

for i in range(len(vecs)):
# for vec in vecs:
    na1t = na1t_base
    psi4.set_options({'perturb_dipole': vecs[i]})
    optimize('M06-2X', molecule=na1t)
    E, wfn = energy('M06-2X', return_wfn=True, molecule=na1t)
    ecp += [E]
    psi4.print_out("-------------------  E-FIELD SCAN REULTS  ---------------------\n")
    psi4.print_out("E-Field                E_int [kj/mol]               \n")
    e = ((ecp[i] - base) * 2625.5)
    psi4.print_out("{:.8e}\t{:.8e}\t{:.8e}\t{}\n".format(
        vecs[i][0], vecs[i][1], vecs[i][2], e))
    with open("efield_perturbation.csv", "a") as f:
      f.write("{:.8e}, {:.8e}, {:.8e}, {}, {}, {}, {}\n".format(
          vecs[i][0], vecs[i][1], vecs[i][2], e, 
          wfn.variable("CURRENT DIPOLE")[0] / 0.3934303,
          wfn.variable("CURRENT DIPOLE")[1] / 0.3934303,
          wfn.variable("CURRENT DIPOLE")[2] / 0.3934303))
    os.mkdir("geoms/{}".format(i+1))
    with open("geoms/{}/geom_{}.xyz".format(i+1, i+1), "w") as f:
      f.write(na1t.save_string_xyz_file())
    psi4.set_options({'cubeprop_filepath': "geoms/{}/".format(i+1)})
    cubeprop(wfn)
    del wfn

psi4.print_out("-------------------  E-FIELD SCAN REULTS  ---------------------\n")
psi4.print_out("\n")
psi4.print_out("E-Field(x)\tE-Field(y)\tE-Field(z)\tE_int\t[kj/mol]\n")
psi4.print_out("---------------------------------------------------------------\n")
for i in range(len(vecs)):
# for vec in vecs:
    e = ((ecp[i] - base) * 2625.5)
    psi4.print_out("{:.8e}\t{:.8e}\t{:.8e}\t{}\n".format(
        vecs[i][0], vecs[i][1], vecs[i][2], e))

